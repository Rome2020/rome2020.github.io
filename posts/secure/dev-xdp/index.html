<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>XDP 开发手册 - Rome&#39;s Blog</title><meta name="Description" content=""><meta property="og:title" content="XDP 开发手册" />
<meta property="og:description" content="本文档记录实际开发中的细节和要点。 关联文档 xdp相关调研 XDP 技术文档 XDP 现有项目调研 更新说明： 20220301：02-basic-firewal" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/posts/secure/dev-xdp/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-08T19:24:29+08:00" />
<meta property="article:modified_time" content="2022-03-08T19:24:29+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="XDP 开发手册"/>
<meta name="twitter:description" content="本文档记录实际开发中的细节和要点。 关联文档 xdp相关调研 XDP 技术文档 XDP 现有项目调研 更新说明： 20220301：02-basic-firewal"/>
<meta name="application-name" content="Rome&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Rome&#39;s Blog"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://example.org/posts/secure/dev-xdp/" /><link rel="prev" href="http://example.org/posts/secure/about-xdp/" /><link rel="next" href="http://example.org/posts/secure/dev-ebpf-with-go/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "XDP 开发手册",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/example.org\/posts\/secure\/dev-xdp\/"
        },"genre": "posts","wordcount":  7692 ,
        "url": "http:\/\/example.org\/posts\/secure\/dev-xdp\/","datePublished": "2022-03-08T19:24:29+08:00","dateModified": "2022-03-08T19:24:29+08:00","publisher": {
            "@type": "Organization",
            "name": "Rome"},"author": {
                "@type": "Person",
                "name": "Rome"
            },"description": ""
    }
    </script></head>
    <body header-desktop="" header-mobile=""><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Rome&#39;s Blog">Rome&#39;s Blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/" title="文章"> 文章 </a><a class="menu-item" href="/tags/" title="标签"> 标签 </a><a class="menu-item" href="/categories/" title="分类"> 分类 </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Rome&#39;s Blog">Rome&#39;s Blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="文章">文章</a><a class="menu-item" href="/tags/" title="标签">标签</a><a class="menu-item" href="/categories/" title="分类">分类</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">XDP 开发手册</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Rome</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2022-03-08">2022-03-08</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 7692 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 16 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#关联文档">关联文档</a></li>
    <li><a href="#更新说明">更新说明：</a></li>
    <li><a href="#一个最小的完整-xdp-程序">一个最小的完整 XDP 程序</a>
      <ul>
        <li><a href="#测试环境">测试环境</a></li>
        <li><a href="#代码分析">代码分析</a></li>
        <li><a href="#测试流程">测试流程</a></li>
        <li><a href="#问题和总结">问题和总结</a></li>
      </ul>
    </li>
    <li><a href="#更进一步">更进一步</a></li>
    <li><a href="#安装依赖">安装依赖</a></li>
    <li><a href="#ubuntu-1604-测试">Ubuntu 16.04 测试</a></li>
    <li><a href="#02-basic-firewall">02-basic-firewall</a>
      <ul>
        <li><a href="#运行测试">运行测试</a></li>
        <li><a href="#代码分析-1">代码分析</a></li>
        <li><a href="#代码">代码</a></li>
      </ul>
    </li>
    <li><a href="#03-fentry">03-fentry</a>
      <ul>
        <li><a href="#测试过程">测试过程</a></li>
        <li><a href="#go-generate">go generate</a></li>
        <li><a href="#go-build">go build</a></li>
        <li><a href="#代码-1">代码</a></li>
      </ul>
    </li>
    <li><a href="#04-xdp1-c">04-xdp1-c</a>
      <ul>
        <li><a href="#混乱的头文件">混乱的头文件</a></li>
      </ul>
    </li>
    <li><a href="#05-xdp1-go">05-xdp1-go</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>本文档记录实际开发中的细节和要点。</p>
<h2 id="关联文档">关联文档</h2>
<ul>
<li><a href="https://shimo.im/docs/hG6JKtPtH6hR93GW" target="_blank" rel="noopener noreffer">xdp相关调研</a></li>
<li><a href="https://shimo.im/docs/m4kML79M9nfRyEqD" target="_blank" rel="noopener noreffer">XDP 技术文档</a></li>
<li><a href="https://shimo.im/docs/L9kBMXvb7gC94ZqK" target="_blank" rel="noopener noreffer">XDP 现有项目调研</a></li>
</ul>
<hr>
<h2 id="更新说明">更新说明：</h2>
<ul>
<li>20220301：<a href="https://shimo.im/docs/5bqnr4BnGNhZLDqy#anchor-ytqp" target="_blank" rel="noopener noreffer">02-basic-firewall</a> go开发XDP用户态程序实践</li>
<li>0303：<a href="https://shimo.im/docs/5bqnr4BnGNhZLDqy#anchor-fAPw" target="_blank" rel="noopener noreffer">03-fentry</a></li>
<li>0308：更新 <a href="#%E4%B8%80%E4%B8%AA%E6%9C%80%E5%B0%8F%E7%9A%84%E5%AE%8C%E6%95%B4-xdp-%E7%A8%8B%E5%BA%8F" rel="">一个最小的完整 XDP 程序</a> 部分内容</li>
</ul>
<h2 id="一个最小的完整-xdp-程序">一个最小的完整 XDP 程序</h2>
<h3 id="测试环境">测试环境</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ uname -r
5.4.0-91-generic

$ lsb_release -a
No LSB modules are available.
Distributor ID: Ubuntu
Description:    Ubuntu 20.04.4 LTS
Release:        20.04
Codename:       focal

$ llvm-as --version
LLVM <span class="o">(</span>http://llvm.org/<span class="o">)</span>:
  LLVM version 10.0.0

  Optimized build.
  Default target: x86_64-pc-linux-gnu
  Host CPU: skylake

$ clang --version
clang version 10.0.0-4ubuntu1
Target: x86_64-pc-linux-gnu
Thread model: posix
InstalledDir: /usr/bin
</code></pre></td></tr></table>
</div>
</div><h3 id="代码分析">代码分析</h3>
<p>下面是一个最小的完整 XDP 程序，实现了丢弃包的功能：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c">  <span class="mi">1</span> <span class="c1">//xdp-drop0.c
</span><span class="c1"></span>  <span class="mi">2</span> <span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">linux</span><span class="o">/</span><span class="n">bpf</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
  <span class="mi">3</span>
  <span class="mi">4</span> <span class="err">#</span><span class="n">ifndef</span> <span class="n">SEC</span>
  <span class="mi">5</span> <span class="err">#</span><span class="n">define</span> <span class="n">SEC</span><span class="p">(</span><span class="n">NAME</span><span class="p">)</span> \
  <span class="mi">6</span>     <span class="n">__attribute__</span><span class="p">((</span><span class="n">section</span><span class="p">(</span><span class="n">NAME</span><span class="p">),</span> <span class="n">used</span><span class="p">))</span>
  <span class="mi">7</span> <span class="err">#</span><span class="n">endif</span>
  <span class="mi">8</span>
  <span class="mi">9</span> <span class="n">SEC</span><span class="p">(</span><span class="s">&#34;prog&#34;</span><span class="p">)</span>
 <span class="mi">10</span> <span class="kt">int</span> <span class="n">xdp_drop</span><span class="p">(</span><span class="k">struct</span> <span class="n">xdp_md</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
 <span class="mi">11</span> <span class="p">{</span>
 <span class="mi">12</span>     <span class="k">return</span> <span class="n">XDP_DROP</span><span class="p">;</span>
 <span class="mi">13</span> <span class="p">}</span>
 <span class="mi">14</span>
 <span class="mi">15</span> <span class="kt">char</span> <span class="n">__license</span><span class="p">[]</span> <span class="n">SEC</span><span class="p">(</span><span class="s">&#34;license&#34;</span><span class="p">)</span> <span class="o">=</span> <span class="s">&#34;GPL&#34;</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>我们从这个简单的程序出发来了解 XDP。</p>
<p>L2 引入了 <a href="https://elixir.bootlin.com/linux/latest/source/include/linux/bpf.h" target="_blank" rel="noopener noreffer">linux/bpf.h</a> 头文件，接下来的 <code>struct xdp_md</code> 和 <code>XDP_DROP</code> 依赖于这个头文件。XDP 所需的最小内核版本为 4.8，本次测试环境内核版本为 5.4，符合要求。</p>
<p>L4-L7 定义了一个宏 <code>SEC</code>，通过 <code>__attribute__</code> 编译器指令设置了 <a href="https://gcc.gnu.org/onlinedocs/gcc/Common-Variable-Attributes.html#:~:text=section%20%28%22section%2Dname%22%29" target="_blank" rel="noopener noreffer">section</a> 和 <a href="https://gcc.gnu.org/onlinedocs/gcc/Common-Variable-Attributes.html#:~:text=variable%20or%20field.-,used,-This%20attribute%2C%20attached" target="_blank" rel="noopener noreffer">used</a> 属性，<a href="https://gcc.gnu.org/onlinedocs/gcc/Common-Variable-Attributes.html#:~:text=section%20%28%22section%2Dname%22%29" target="_blank" rel="noopener noreffer">section</a> 是将作用的函数或数据放入指定名为&quot;section_name&quot;对应的段中，<a href="https://gcc.gnu.org/onlinedocs/gcc/Common-Variable-Attributes.html#:~:text=variable%20or%20field.-,used,-This%20attribute%2C%20attached" target="_blank" rel="noopener noreffer">used</a> 指示编译器在对象文件中保留静态函数or变量，即使没有被引用。宏 <code>SEC</code> 标准定义在 <a href="https://elixir.bootlin.com/linux/v5.16.5/source/tools/lib/bpf/bpf_helpers.h" target="_blank" rel="noopener noreffer">bpf_helpers.h</a> 中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="cm">/*
</span><span class="cm"> * Helper macro to place programs, maps, license in
</span><span class="cm"> * different sections in elf_bpf file. Section names
</span><span class="cm"> * are interpreted by libbpf depending on the context (BPF programs, BPF maps,
</span><span class="cm"> * extern variables, etc).
</span><span class="cm"> * To allow use of SEC() with externs (e.g., for extern .maps declarations),
</span><span class="cm"> * make sure __attribute__((unused)) doesn&#39;t trigger compilation warning.
</span><span class="cm"> */</span>
<span class="cp">#define SEC(name) \
</span><span class="cp">	_Pragma(&#34;GCC diagnostic push&#34;)					    \
</span><span class="cp">	_Pragma(&#34;GCC diagnostic ignored \&#34;-Wignored-attributes\&#34;&#34;)	    \
</span><span class="cp">	__attribute__((section(name), used))				    \
</span><span class="cp">	_Pragma(&#34;GCC diagnostic pop&#34;)					    \
</span></code></pre></td></tr></table>
</div>
</div><p>考虑简洁和方便，我们的程序中并没有直接引用 <a href="https://elixir.bootlin.com/linux/v5.16.5/source/tools/lib/bpf/bpf_helpers.h" target="_blank" rel="noopener noreffer">bpf_helpers.h</a>，宏 <code>SEC</code> 的定义也是简化的。</p>
<p>L9 指定一个新段 <code>prog</code>。L10-L13 是函数 <code>int xdp_drop()</code>，函数的输入类型是 <a href="https://elixir.bootlin.com/linux/v5.4.91/source/include/uapi/linux/bpf.h#L3161" target="_blank" rel="noopener noreffer">struct xdp_md</a>，返回值是 <a href="https://elixir.bootlin.com/linux/v5.4.91/source/include/uapi/linux/bpf.h#L3152" target="_blank" rel="noopener noreffer">XDP_DROP</a><br>
<code>struct xdp_md</code>的具体字段如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cm">/* user accessible metadata for XDP packet hook
</span><span class="cm"> * new fields must be added to the end of this structure
</span><span class="cm"> */</span>
<span class="k">struct</span> <span class="n">xdp_md</span> <span class="p">{</span>
	<span class="n">__u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">data_end</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">data_meta</span><span class="p">;</span>
	<span class="cm">/* Below access go through struct xdp_rxq_info */</span>
	<span class="n">__u32</span> <span class="n">ingress_ifindex</span><span class="p">;</span> <span class="cm">/* rxq-&gt;dev-&gt;ifindex */</span>
	<span class="n">__u32</span> <span class="n">rx_queue_index</span><span class="p">;</span>  <span class="cm">/* rxq-&gt;queue_index  */</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>程序执行时，<code>data</code> 和 <code>data_end</code> 字段分别是数据包开始和结束的指针，它们是用来获取和解析传来的数据，第三个值是 <code>data_meta</code> 指针，初始阶段它是一个空闲的内存地址，供 XDP 程序与其他层交换数据包元数据时使用。最后两个字段分别是接收数据包的接口和对应的 RX 队列的索引。当访问这两个值时，BPF 代码会在内核内部重写，以访问实际持有这些值的内核结构 <code>struct xdp_rxq_info</code>。</p>
<p><code>XDP_DROP</code> 的定义如下，即 XDP_DROP 本质就是 1。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">enum</span> <span class="n">xdp_action</span> <span class="p">{</span>
	<span class="n">XDP_ABORTED</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">XDP_DROP</span><span class="p">,</span>
	<span class="n">XDP_PASS</span><span class="p">,</span>
	<span class="n">XDP_TX</span><span class="p">,</span>
	<span class="n">XDP_REDIRECT</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>L15，指定证书，内核会使用许可证 section 验证程序是否与内核许可证兼容。</p>
<h3 id="测试流程">测试流程</h3>
<p>编译：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ clang -O2 -Wall -target bpf -c xdp-drop0.c -o xdp-drop0.o
</code></pre></td></tr></table>
</div>
</div><p>使用 <code>llvm-objdump</code> 进行反汇编：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ llvm-objdump -S xdp-drop0.o

xdp-drop0.o:    file format ELF64-BPF


Disassembly of section prog:

<span class="m">0000000000000000</span> xdp_drop:
llvm-objdump: warning: <span class="s1">&#39;xdp-drop0.o&#39;</span>: failed to parse debug information <span class="k">for</span> xdp-drop0.o
       0:       b7 <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">01</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="nv">r0</span> <span class="o">=</span> <span class="m">1</span>
       1:       <span class="m">95</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="nb">exit</span>
</code></pre></td></tr></table>
</div>
</div><p>从反汇编的结果就容易理解前面的分析了，比如 <code>section prog</code> 和 <code>r0 = 1</code>。</p>
<p>接下来加载到内核：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>ip a show lo
<span class="go">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
</span><span class="go">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span><span class="go">    inet 127.0.0.1/8 scope host lo
</span><span class="go">       valid_lft forever preferred_lft forever
</span><span class="go">    inet6 ::1/128 scope host 
</span><span class="go">       valid_lft forever preferred_lft forever
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="gp">$ </span>sudo ip link <span class="nb">set</span> dev lo xdp obj xdp-drop0.o
<span class="err">
</span><span class="err"></span><span class="gp">$ </span>ip a show lo
<span class="go">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 xdpgeneric/id:99 qdisc noqueue state UNKNOWN group default qlen 1000
</span><span class="go">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span><span class="go">    inet 127.0.0.1/8 scope host lo
</span><span class="go">       valid_lft forever preferred_lft forever
</span><span class="go">    inet6 ::1/128 scope host 
</span><span class="go">       valid_lft forever preferred_lft forever
</span><span class="go">     
</span><span class="go"></span><span class="gp">$ </span>ping -c8 127.0.0.1
<span class="go">PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">--- 127.0.0.1 ping 统计 ---
</span><span class="go">已发送 8 个包， 已接收 0 个包, 100% 包丢失, 耗时 7168 毫秒
</span></code></pre></td></tr></table>
</div>
</div><p>从内核卸载：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>sudo ip link <span class="nb">set</span> dev lo xdp off
<span class="err">
</span><span class="err"></span><span class="gp">$ </span>ip a show lo
<span class="go">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
</span><span class="go">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span><span class="go">    inet 127.0.0.1/8 scope host lo
</span><span class="go">       valid_lft forever preferred_lft forever
</span><span class="go">    inet6 ::1/128 scope host 
</span><span class="go">       valid_lft forever preferred_lft forever
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="gp">$ </span>ping -c4 127.0.0.1
<span class="go">PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
</span><span class="go">64 比特，来自 127.0.0.1: icmp_seq=1 ttl=64 时间=0.080 毫秒
</span><span class="go">64 比特，来自 127.0.0.1: icmp_seq=2 ttl=64 时间=0.080 毫秒
</span><span class="go">64 比特，来自 127.0.0.1: icmp_seq=3 ttl=64 时间=0.091 毫秒
</span><span class="go">64 比特，来自 127.0.0.1: icmp_seq=4 ttl=64 时间=0.075 毫秒
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">--- 127.0.0.1 ping 统计 ---
</span><span class="go">已发送 4 个包， 已接收 4 个包, 0% 包丢失, 耗时 3059 毫秒
</span><span class="go">rtt min/avg/max/mdev = 0.075/0.081/0.091/0.005 ms
</span></code></pre></td></tr></table>
</div>
</div><h3 id="问题和总结">问题和总结</h3>
<p>上面的例子简单说明了 XDP 模块如何编写并应用的完整过程，不过这样简单的功能还不能满足实际需求。</p>
<p>另外还有一些问题，前面提到列出的内核代码链接，有的并不是同一个内核版本，造成这样的原因并不是我偷懒，而是内核头文件的复杂依赖和 eBPF 的开发迭代使得不同内核版本中路径不一致，这是接下来要解决的问题之一。</p>
<p>另外接下来也会通过实现更复杂的功能来深入 XDP。</p>
<h2 id="更进一步">更进一步</h2>
<p>更具体的要求包括但不限于：</p>
<ul>
<li>XDP 大概流程，实现原理
<ul>
<li>XDP 运行在哪里</li>
<li>XDP 如何接收输入</li>
<li>XDP 的输出是什么</li>
<li>XDP 可以持久化吗</li>
</ul>
</li>
<li>怎么做ips功能
<ul>
<li>策略如何写</li>
<li>用什么方式/格式/语言写</li>
<li>限制有哪些</li>
</ul>
</li>
<li>开发方面：
<ul>
<li>需要哪些依赖</li>
<li>Linux 内核最低版本</li>
<li>是否方便适配</li>
</ul>
</li>
</ul>
<h2 id="安装依赖">安装依赖</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">sudo apt install clang llvm libelf-dev libpcap-dev gcc-multilib build-essential <span class="se">\
</span><span class="se"></span>linux-tools-<span class="k">$(</span>uname -r<span class="k">)</span> <span class="se">\
</span><span class="se"></span>linux-headers-<span class="k">$(</span>uname -r<span class="k">)</span> <span class="se">\
</span><span class="se"></span>linux-tools-common linux-tools-generic
</code></pre></td></tr></table>
</div>
</div><h2 id="ubuntu-1604-测试">Ubuntu 16.04 测试</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>uname -r
<span class="go">4.15.0-142-generic
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="gp">$ </span>clang -O2 -Wall -target bpf -c xdp-example.c -o xdp-example.o
<span class="go">xdp-example.c:9:21: warning: declaration of &#39;struct xdp_md&#39; will not be visible outside of this function [-Wvisibility]
</span><span class="go">int xdp_drop(struct xdp_md *ctx)
</span><span class="go">                    ^
</span><span class="go">xdp-example.c:11:12: error: use of undeclared identifier &#39;XDP_DROP&#39;
</span><span class="go">    return XDP_DROP;
</span><span class="go">           ^
</span><span class="go">1 warning and 1 error generated.
</span></code></pre></td></tr></table>
</div>
</div><h2 id="02-basic-firewall">02-basic-firewall</h2>
<blockquote>
<p><a href="https://github.com/dropbox/goebpf/tree/master/examples/xdp/basic_firewall" target="_blank" rel="noopener noreffer">https://github.com/dropbox/goebpf/tree/master/examples/xdp/basic_firewall</a>
该例子是使用 Go 语言的一个实践，即：</p>
</blockquote>
<ul>
<li>内核态 XDP 模块使用 C 语言实现</li>
<li>用户态和模块加载使用 Go 语言实现
核心文件有两个：<code>xdp-fw.c</code> 和 <code>main.go</code></li>
</ul>
<h3 id="运行测试">运行测试</h3>
<p>先编译运行代码，了解功能，后面再详细分析。</p>
<p><code>Makefile</code> 如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="c"># for XDP 
</span><span class="c"></span><span class="nv">CLANG</span> <span class="o">:=</span> clang
<span class="nv">CFLAGS</span><span class="o">=</span>-O -Wall -Werror

<span class="nv">DEV</span><span class="o">=</span>lo

<span class="nv">CLANG_INCLUDE</span> <span class="o">:=</span> -I./

<span class="nv">EBPF_SOURCE</span> <span class="o">:=</span> ebpf_prog/xdp-fw.c
<span class="nv">EBPF_BINARY</span> <span class="o">:=</span> ebpf_prog/xdp-fw.elf

<span class="c"># for go
</span><span class="c"></span><span class="nv">GOCMD</span> <span class="o">:=</span> go
<span class="nv">GOBUILD</span> <span class="o">:=</span> <span class="k">$(</span>GOCMD<span class="k">)</span> build
<span class="nv">GOCLEAN</span> <span class="o">:=</span> <span class="k">$(</span>GOCMD<span class="k">)</span> clean
<span class="nv">GO_SOURCE</span> <span class="o">:=</span> main.go
<span class="nv">GO_BINARY</span> <span class="o">:=</span> main

<span class="nf">all</span><span class="o">:</span> <span class="n">build_bpf</span> <span class="n">build_go</span>

<span class="nf">build_bpf</span><span class="o">:</span> <span class="k">$(</span><span class="nv">EBPF_BINARY</span><span class="k">)</span>

<span class="nf">build_go</span><span class="o">:</span> <span class="k">$(</span><span class="nv">GO_BINARY</span><span class="k">)</span>

<span class="nf">clean</span><span class="o">:</span>
    <span class="k">$(</span><span class="nv">GOCLEAN</span><span class="k">)</span>
    <span class="err">rm</span> <span class="err">-f</span> <span class="k">$(</span><span class="nv">GO_BINARY</span><span class="k">)</span>
    <span class="err">rm</span> <span class="err">-f</span> <span class="k">$(</span><span class="nv">EBPF_BINARY</span><span class="k">)</span>

<span class="nf">$(EBPF_BINARY)</span><span class="o">:</span> <span class="k">$(</span><span class="nv">EBPF_SOURCE</span><span class="k">)</span>
    <span class="k">$(</span><span class="nv">CLANG</span><span class="k">)</span> <span class="k">$(</span><span class="nv">CLANG_INCLUDE</span><span class="k">)</span> <span class="k">$(</span><span class="nv">CFLAGS</span><span class="k">)</span> <span class="err">-target</span> <span class="err">bpf</span> <span class="err">-c</span> <span class="err">$^</span>  <span class="err">-o</span> <span class="k">$@</span>

<span class="nf">$(GO_BINARY)</span><span class="o">:</span> <span class="k">$(</span><span class="nv">GO_SOURCE</span><span class="k">)</span>
    <span class="k">$(</span><span class="nv">GOBUILD</span><span class="k">)</span> <span class="err">-v</span> <span class="err">-o</span> <span class="k">$@</span>
</code></pre></td></tr></table>
</div>
</div><p>编译好后会生成两个文件：</p>
<ul>
<li>
<p><code>xdp-fw.elf</code> : eBPF 字节码</p>
</li>
<li>
<p><code>main</code> : 用户态管理程序
测试环境说明：</p>
</li>
<li>
<p>Windows Host（192.168.0.109）</p>
</li>
<li>
<p>Ubuntu Guest（192.168.0.106）
未运行时信息：</p>
</li>
</ul>
<p>Windows：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="nb">PS </span><span class="n">F:</span><span class="p">\</span><span class="n">projects</span><span class="p">&gt;</span> <span class="n">ping</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">106</span>

<span class="n">正在</span> <span class="n">Ping</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">106</span> <span class="n">具有</span> <span class="n">32</span> <span class="n">字节的数据</span><span class="err">:</span>
<span class="n">来自</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">106</span> <span class="n">的回复</span><span class="err">:</span> <span class="n">字节</span><span class="p">=</span><span class="n">32</span> <span class="n">时间</span><span class="p">&lt;</span><span class="n">1ms</span> <span class="n">TTL</span><span class="p">=</span><span class="n">64</span>
<span class="n">来自</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">106</span> <span class="n">的回复</span><span class="err">:</span> <span class="n">字节</span><span class="p">=</span><span class="n">32</span> <span class="n">时间</span><span class="p">&lt;</span><span class="n">1ms</span> <span class="n">TTL</span><span class="p">=</span><span class="n">64</span>
<span class="n">来自</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">106</span> <span class="n">的回复</span><span class="err">:</span> <span class="n">字节</span><span class="p">=</span><span class="n">32</span> <span class="n">时间</span><span class="p">&lt;</span><span class="n">1ms</span> <span class="n">TTL</span><span class="p">=</span><span class="n">64</span>
<span class="n">来自</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">106</span> <span class="n">的回复</span><span class="err">:</span> <span class="n">字节</span><span class="p">=</span><span class="n">32</span> <span class="n">时间</span><span class="p">&lt;</span><span class="n">1ms</span> <span class="n">TTL</span><span class="p">=</span><span class="n">64</span>

<span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">106</span> <span class="n">的</span> <span class="n">Ping</span> <span class="n">统计信息</span><span class="err">:</span>
    <span class="n">数据包</span><span class="err">:</span> <span class="n">已发送</span> <span class="p">=</span> <span class="n">4</span><span class="err">，</span><span class="n">已接收</span> <span class="p">=</span> <span class="n">4</span><span class="err">，</span><span class="n">丢失</span> <span class="p">=</span> <span class="n">0</span> <span class="p">(</span><span class="n">0</span><span class="p">%</span> <span class="n">丢失</span><span class="p">)</span><span class="err">，</span>
<span class="n">往返行程的估计时间</span><span class="p">(</span><span class="n">以毫秒为单位</span><span class="p">)</span><span class="err">:</span>
    <span class="n">最短</span> <span class="p">=</span> <span class="n">0ms</span><span class="err">，</span><span class="n">最长</span> <span class="p">=</span> <span class="n">0ms</span><span class="err">，</span><span class="n">平均</span> <span class="p">=</span> <span class="n">0ms</span>
</code></pre></td></tr></table>
</div>
</div><p>Ubuntu：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>ip a 
<span class="go">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
</span><span class="go">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span><span class="go">    inet 127.0.0.1/8 scope host lo
</span><span class="go">       valid_lft forever preferred_lft forever
</span><span class="go">    inet6 ::1/128 scope host 
</span><span class="go">       valid_lft forever preferred_lft forever
</span><span class="go">2: enp0s3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
</span><span class="go">    link/ether 08:00:27:7a:53:ec brd ff:ff:ff:ff:ff:ff
</span><span class="go">    inet 192.168.0.106/24 brd 192.168.0.255 scope global dynamic noprefixroute enp0s3
</span><span class="go">       valid_lft 5874sec preferred_lft 5874sec
</span><span class="go">    inet6 fe80::5a53:77ea:d901:b030/64 scope link noprefixroute 
</span><span class="go">       valid_lft forever preferred_lft forever
</span></code></pre></td></tr></table>
</div>
</div><p>运行程序，需要指定网卡和IP：<br>
Ubuntu：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">sudo ./main -iface enp0s3 -drop 192.168.0.109
</span><span class="go">Maps:
</span><span class="go">    matches: Per-CPU array, Fd 7
</span><span class="go">    blacklist: Longest prefix match trie, Fd 8
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">Programs:
</span><span class="go">    firewall: XDP, size 400, license &#34;GPLv2&#34;
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">Blacklisting IPv4 addresses...
</span><span class="go">    192.168.0.109/32
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">XDP program successfully loaded and attached. Counters refreshed every second.
</span><span class="go">Press CTRL+C to stop.
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">IP                 DROPs
</span><span class="go">  192.168.0.109/32    0
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">IP                 DROPs
</span><span class="go">  192.168.0.109/32    0
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">IP                 DROPs
</span><span class="go">  192.168.0.109/32    1
</span></code></pre></td></tr></table>
</div>
</div><p>Windows：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="nb">PS </span><span class="n">F:</span><span class="p">\</span><span class="n">projects</span><span class="p">&gt;</span> <span class="n">ping</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">106</span>

<span class="n">正在</span> <span class="n">Ping</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">106</span> <span class="n">具有</span> <span class="n">32</span> <span class="n">字节的数据</span><span class="err">:</span>
<span class="n">请求超时</span><span class="err">。</span>
<span class="n">请求超时</span><span class="err">。</span>
<span class="n">请求超时</span><span class="err">。</span>
<span class="n">请求超时</span><span class="err">。</span>

<span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">106</span> <span class="n">的</span> <span class="n">Ping</span> <span class="n">统计信息</span><span class="err">:</span>
    <span class="n">数据包</span><span class="err">:</span> <span class="n">已发送</span> <span class="p">=</span> <span class="n">4</span><span class="err">，</span><span class="n">已接收</span> <span class="p">=</span> <span class="n">0</span><span class="err">，</span><span class="n">丢失</span> <span class="p">=</span> <span class="n">4</span> <span class="p">(</span><span class="n">100</span><span class="p">%</span> <span class="n">丢失</span><span class="p">)</span><span class="err">，</span>
</code></pre></td></tr></table>
</div>
</div><p>很明显这个简易防火墙起作用了，在 Ubuntu 上也可以看到 XDP 已经加载到了 enp0s3 网卡上</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>ip a 
<span class="go">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
</span><span class="go">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span><span class="go">    inet 127.0.0.1/8 scope host lo
</span><span class="go">       valid_lft forever preferred_lft forever
</span><span class="go">    inet6 ::1/128 scope host 
</span><span class="go">       valid_lft forever preferred_lft forever
</span><span class="go">2: enp0s3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 xdpgeneric/id:227 qdisc fq_codel state UP group default qlen 1000
</span><span class="go">    link/ether 08:00:27:7a:53:ec brd ff:ff:ff:ff:ff:ff
</span><span class="go">    inet 192.168.0.106/24 brd 192.168.0.255 scope global dynamic noprefixroute enp0s3
</span><span class="go">       valid_lft 4199sec preferred_lft 4199sec
</span><span class="go">    inet6 fe80::5a53:77ea:d901:b030/64 scope link noprefixroute 
</span><span class="go">       valid_lft forever preferred_lft forever
</span></code></pre></td></tr></table>
</div>
</div><p><code>CTRL+C</code> 退出程序之后，再查看网卡信息：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>ip a 
<span class="go">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
</span><span class="go">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span><span class="go">    inet 127.0.0.1/8 scope host lo
</span><span class="go">       valid_lft forever preferred_lft forever
</span><span class="go">    inet6 ::1/128 scope host 
</span><span class="go">       valid_lft forever preferred_lft forever
</span><span class="go">2: enp0s3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
</span><span class="go">    link/ether 08:00:27:7a:53:ec brd ff:ff:ff:ff:ff:ff
</span><span class="go">    inet 192.168.0.106/24 brd 192.168.0.255 scope global dynamic noprefixroute enp0s3
</span><span class="go">       valid_lft 3977sec preferred_lft 3977sec
</span><span class="go">    inet6 fe80::5a53:77ea:d901:b030/64 scope link noprefixroute 
</span><span class="go">       valid_lft forever preferred_lft forever
</span></code></pre></td></tr></table>
</div>
</div><p>已经恢复正常</p>
<h3 id="代码分析-1">代码分析</h3>
<p><code>xdp-fw.c</code>中最重要的一段逻辑如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="c1">// Lookup SRC IP in blacklisted IPs
</span><span class="c1"></span>  <span class="n">__u64</span> <span class="o">*</span><span class="n">rule_idx</span> <span class="o">=</span> <span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">blacklist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">rule_idx</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Matched, increase match counter for matched &#34;rule&#34;
</span><span class="c1"></span>    <span class="n">__u32</span> <span class="n">index</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">__u32</span><span class="o">*</span><span class="p">)</span><span class="n">rule_idx</span><span class="p">;</span>  <span class="c1">// make verifier happy
</span><span class="c1"></span>    <span class="n">__u64</span> <span class="o">*</span><span class="n">counter</span> <span class="o">=</span> <span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">matches</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">index</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">counter</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">(</span><span class="o">*</span><span class="n">counter</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">XDP_DROP</span><span class="p">;</span><span class="mi">1</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>bpf_map_lookup_elem</code> 是一个 eBPF 辅助函数，函数原型：<code>void *bpf_map_lookup_elem(const void *map, const void *key);</code>
可以通过 key 查询 BPF Map，得到对应 value。这里的 BPF Map 是 <code>blacklist</code>，一个结构体：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="n">BPF_MAP_DEF</span><span class="p">(</span><span class="n">blacklist</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">map_type</span> <span class="o">=</span> <span class="n">BPF_MAP_TYPE_LPM_TRIE</span><span class="p">,</span>
    <span class="p">.</span><span class="n">key_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__u64</span><span class="p">),</span>
    <span class="p">.</span><span class="n">value_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__u32</span><span class="p">),</span>
    <span class="p">.</span><span class="n">max_entries</span> <span class="o">=</span> <span class="n">MAX_RULES</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">BPF_MAP_ADD</span><span class="p">(</span><span class="n">blacklist</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>但这里没有实际的数据，实际的数据是在用户态提供的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">blacklist</span> <span class="o">:=</span> <span class="nx">bpf</span><span class="p">.</span><span class="nf">GetMapByName</span><span class="p">(</span><span class="s">&#34;blacklist&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">blacklist</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nf">fatalError</span><span class="p">(</span><span class="s">&#34;eBPF map &#39;blacklist&#39; not found&#34;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// Get XDP program. Name simply matches function from xdp_fw.c:
</span><span class="c1"></span>    <span class="c1">//      int firewall(struct xdp_md *ctx) {
</span><span class="c1"></span>    <span class="nx">xdp</span> <span class="o">:=</span> <span class="nx">bpf</span><span class="p">.</span><span class="nf">GetProgramByName</span><span class="p">(</span><span class="s">&#34;firewall&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">xdp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nf">fatalError</span><span class="p">(</span><span class="s">&#34;Program &#39;firewall&#39; not found.&#34;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// Populate eBPF map with IPv4 addresses to block
</span><span class="c1"></span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Blacklisting IPv4 addresses...&#34;</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">ip</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">ipList</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;\t%s\n&#34;</span><span class="p">,</span> <span class="nx">ip</span><span class="p">)</span>
        <span class="nx">err</span> <span class="o">:=</span> <span class="nx">blacklist</span><span class="p">.</span><span class="nf">Insert</span><span class="p">(</span><span class="nx">goebpf</span><span class="p">.</span><span class="nf">CreateLPMtrieKey</span><span class="p">(</span><span class="nx">ip</span><span class="p">),</span> <span class="nx">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nf">fatalError</span><span class="p">(</span><span class="s">&#34;Unable to Insert into eBPF map: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>上面这段代码完成了 <code>blacklist</code> 的定义，数据添加的功能。所以通过这样的方式，就简便的完成了内核和用户态的数据交互。
另外<code>main.go</code>还完成了 XDP 的加载等功能。</p>
<h3 id="代码">代码</h3>
<details>
<summary>xdp-fw.c</summary>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="c1">// Basic XDP firewall (IPv4 blacklisting)
</span><span class="c1"></span>
<span class="cp">#include</span> <span class="cpf">&#34;bpf_helpers.h&#34;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#define MAX_RULES   16
</span><span class="cp"></span>
<span class="c1">// Ethernet header
</span><span class="c1"></span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="p">{</span>
  <span class="n">__u8</span> <span class="n">h_dest</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
  <span class="n">__u8</span> <span class="n">h_source</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
  <span class="n">__u16</span> <span class="n">h_proto</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="c1">// IPv4 header
</span><span class="c1"></span><span class="k">struct</span> <span class="n">iphdr</span> <span class="p">{</span>
  <span class="n">__u8</span> <span class="nl">ihl</span> <span class="p">:</span> <span class="mi">4</span><span class="p">;</span>
  <span class="n">__u8</span> <span class="nl">version</span> <span class="p">:</span> <span class="mi">4</span><span class="p">;</span>
  <span class="n">__u8</span> <span class="n">tos</span><span class="p">;</span>
  <span class="n">__u16</span> <span class="n">tot_len</span><span class="p">;</span>
  <span class="n">__u16</span> <span class="n">id</span><span class="p">;</span>
  <span class="n">__u16</span> <span class="n">frag_off</span><span class="p">;</span>
  <span class="n">__u8</span> <span class="n">ttl</span><span class="p">;</span>
  <span class="n">__u8</span> <span class="n">protocol</span><span class="p">;</span>
  <span class="n">__u16</span> <span class="n">check</span><span class="p">;</span>
  <span class="n">__u32</span> <span class="n">saddr</span><span class="p">;</span>
  <span class="n">__u32</span> <span class="n">daddr</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>


<span class="n">BPF_MAP_DEF</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">map_type</span> <span class="o">=</span> <span class="n">BPF_MAP_TYPE_PERCPU_ARRAY</span><span class="p">,</span>
    <span class="p">.</span><span class="n">key_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__u32</span><span class="p">),</span>
    <span class="p">.</span><span class="n">value_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__u64</span><span class="p">),</span>
    <span class="p">.</span><span class="n">max_entries</span> <span class="o">=</span> <span class="n">MAX_RULES</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">BPF_MAP_ADD</span><span class="p">(</span><span class="n">matches</span><span class="p">);</span>


<span class="n">BPF_MAP_DEF</span><span class="p">(</span><span class="n">blacklist</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">map_type</span> <span class="o">=</span> <span class="n">BPF_MAP_TYPE_LPM_TRIE</span><span class="p">,</span>
    <span class="p">.</span><span class="n">key_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__u64</span><span class="p">),</span>
    <span class="p">.</span><span class="n">value_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__u32</span><span class="p">),</span>
    <span class="p">.</span><span class="n">max_entries</span> <span class="o">=</span> <span class="n">MAX_RULES</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">BPF_MAP_ADD</span><span class="p">(</span><span class="n">blacklist</span><span class="p">);</span>

<span class="c1">// XDP program //
</span><span class="c1"></span><span class="n">SEC</span><span class="p">(</span><span class="s">&#34;xdp&#34;</span><span class="p">)</span>
<span class="kt">int</span> <span class="n">firewall</span><span class="p">(</span><span class="k">struct</span> <span class="n">xdp_md</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">data_end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">data_end</span><span class="p">;</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

  <span class="c1">// Only IPv4 supported for this example
</span><span class="c1"></span>  <span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">ether</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ether</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">data_end</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Malformed Ethernet header
</span><span class="c1"></span>    <span class="k">return</span> <span class="n">XDP_ABORTED</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">ether</span><span class="o">-&gt;</span><span class="n">h_proto</span> <span class="o">!=</span> <span class="mh">0x08U</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// htons(ETH_P_IP) -&gt; 0x08U
</span><span class="c1"></span>    <span class="c1">// Non IPv4 traffic
</span><span class="c1"></span>    <span class="k">return</span> <span class="n">XDP_PASS</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">data</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ether</span><span class="p">);</span>
  <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ip</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">data_end</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Malformed IPv4 header
</span><span class="c1"></span>    <span class="k">return</span> <span class="n">XDP_ABORTED</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">struct</span> <span class="p">{</span>
    <span class="n">__u32</span> <span class="n">prefixlen</span><span class="p">;</span>
    <span class="n">__u32</span> <span class="n">saddr</span><span class="p">;</span>
  <span class="p">}</span> <span class="n">key</span><span class="p">;</span>

  <span class="n">key</span><span class="p">.</span><span class="n">prefixlen</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
  <span class="n">key</span><span class="p">.</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">;</span>

  <span class="c1">// Lookup SRC IP in blacklisted IPs
</span><span class="c1"></span>  <span class="n">__u64</span> <span class="o">*</span><span class="n">rule_idx</span> <span class="o">=</span> <span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">blacklist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">rule_idx</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Matched, increase match counter for matched &#34;rule&#34;
</span><span class="c1"></span>    <span class="n">__u32</span> <span class="n">index</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">__u32</span><span class="o">*</span><span class="p">)</span><span class="n">rule_idx</span><span class="p">;</span>  <span class="c1">// make verifier happy
</span><span class="c1"></span>    <span class="n">__u64</span> <span class="o">*</span><span class="n">counter</span> <span class="o">=</span> <span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">matches</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">index</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">counter</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">(</span><span class="o">*</span><span class="n">counter</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">XDP_DROP</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">XDP_PASS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">char</span> <span class="n">_license</span><span class="p">[]</span> <span class="n">SEC</span><span class="p">(</span><span class="s">&#34;license&#34;</span><span class="p">)</span> <span class="o">=</span> <span class="s">&#34;GPLv2&#34;</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div></details>
<details>
<summary>main.go</summary>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Copyright (c) 2019 Dropbox, Inc.
</span><span class="c1">// Full license can be found in the LICENSE file.
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;errors&#34;</span>
	<span class="s">&#34;flag&#34;</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;net&#34;</span>
	<span class="s">&#34;os&#34;</span>
	<span class="s">&#34;os/signal&#34;</span>
	<span class="s">&#34;strings&#34;</span>
	<span class="s">&#34;time&#34;</span>

	<span class="s">&#34;github.com/dropbox/goebpf&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">ipAddressList</span> <span class="p">[]</span><span class="kt">string</span>

<span class="kd">var</span> <span class="nx">iface</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;iface&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;Interface to bind XDP program to&#34;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">elf</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;elf&#34;</span><span class="p">,</span> <span class="s">&#34;ebpf_prog/xdp-fw.elf&#34;</span><span class="p">,</span> <span class="s">&#34;clang/llvm compiled binary file&#34;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">ipList</span> <span class="nx">ipAddressList</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nf">Var</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ipList</span><span class="p">,</span> <span class="s">&#34;drop&#34;</span><span class="p">,</span> <span class="s">&#34;IPv4 CIDR to DROP traffic from, repeatable&#34;</span><span class="p">)</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>
	<span class="k">if</span> <span class="o">*</span><span class="nx">iface</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nf">fatalError</span><span class="p">(</span><span class="s">&#34;-iface is required.&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">ipList</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nf">fatalError</span><span class="p">(</span><span class="s">&#34;at least one IPv4 address to DROP required (-drop)&#34;</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// Create eBPF system
</span><span class="c1"></span>	<span class="nx">bpf</span> <span class="o">:=</span> <span class="nx">goebpf</span><span class="p">.</span><span class="nf">NewDefaultEbpfSystem</span><span class="p">()</span>
	<span class="c1">// Load .ELF files compiled by clang/llvm
</span><span class="c1"></span>	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">bpf</span><span class="p">.</span><span class="nf">LoadElf</span><span class="p">(</span><span class="o">*</span><span class="nx">elf</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">fatalError</span><span class="p">(</span><span class="s">&#34;LoadElf() failed: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nf">printBpfInfo</span><span class="p">(</span><span class="nx">bpf</span><span class="p">)</span>

	<span class="c1">// Get eBPF maps
</span><span class="c1"></span>	<span class="nx">matches</span> <span class="o">:=</span> <span class="nx">bpf</span><span class="p">.</span><span class="nf">GetMapByName</span><span class="p">(</span><span class="s">&#34;matches&#34;</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">matches</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">fatalError</span><span class="p">(</span><span class="s">&#34;eBPF map &#39;matches&#39; not found&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">blacklist</span> <span class="o">:=</span> <span class="nx">bpf</span><span class="p">.</span><span class="nf">GetMapByName</span><span class="p">(</span><span class="s">&#34;blacklist&#34;</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">blacklist</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">fatalError</span><span class="p">(</span><span class="s">&#34;eBPF map &#39;blacklist&#39; not found&#34;</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// Get XDP program. Name simply matches function from xdp_fw.c:
</span><span class="c1"></span>	<span class="c1">//      int firewall(struct xdp_md *ctx) {
</span><span class="c1"></span>	<span class="nx">xdp</span> <span class="o">:=</span> <span class="nx">bpf</span><span class="p">.</span><span class="nf">GetProgramByName</span><span class="p">(</span><span class="s">&#34;firewall&#34;</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">xdp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">fatalError</span><span class="p">(</span><span class="s">&#34;Program &#39;firewall&#39; not found.&#34;</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// Populate eBPF map with IPv4 addresses to block
</span><span class="c1"></span>	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Blacklisting IPv4 addresses...&#34;</span><span class="p">)</span>
	<span class="k">for</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">ip</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">ipList</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;\t%s\n&#34;</span><span class="p">,</span> <span class="nx">ip</span><span class="p">)</span>
		<span class="nx">err</span> <span class="o">:=</span> <span class="nx">blacklist</span><span class="p">.</span><span class="nf">Insert</span><span class="p">(</span><span class="nx">goebpf</span><span class="p">.</span><span class="nf">CreateLPMtrieKey</span><span class="p">(</span><span class="nx">ip</span><span class="p">),</span> <span class="nx">index</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nf">fatalError</span><span class="p">(</span><span class="s">&#34;Unable to Insert into eBPF map: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">()</span>

	<span class="c1">// Load XDP program into kernel
</span><span class="c1"></span>	<span class="nx">err</span> <span class="p">=</span> <span class="nx">xdp</span><span class="p">.</span><span class="nf">Load</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">fatalError</span><span class="p">(</span><span class="s">&#34;xdp.Load(): %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// Attach to interface
</span><span class="c1"></span>	<span class="nx">err</span> <span class="p">=</span> <span class="nx">xdp</span><span class="p">.</span><span class="nf">Attach</span><span class="p">(</span><span class="o">*</span><span class="nx">iface</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">fatalError</span><span class="p">(</span><span class="s">&#34;xdp.Attach(): %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="nx">xdp</span><span class="p">.</span><span class="nf">Detach</span><span class="p">()</span>

	<span class="c1">// Add CTRL+C handler
</span><span class="c1"></span>	<span class="nx">ctrlC</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Signal</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
	<span class="nx">signal</span><span class="p">.</span><span class="nf">Notify</span><span class="p">(</span><span class="nx">ctrlC</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Interrupt</span><span class="p">)</span>

	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;XDP program successfully loaded and attached. Counters refreshed every second.&#34;</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Press CTRL+C to stop.&#34;</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">()</span>

	<span class="c1">// Print stat every second / exit on CTRL+C
</span><span class="c1"></span>	<span class="nx">ticker</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTicker</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="k">select</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ticker</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;IP                 DROPs&#34;</span><span class="p">)</span>
			<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">ipList</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
				<span class="nx">value</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">matches</span><span class="p">.</span><span class="nf">LookupInt</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
				<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
					<span class="nf">fatalError</span><span class="p">(</span><span class="s">&#34;LookupInt failed: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
				<span class="p">}</span>
				<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%18s    %d\n&#34;</span><span class="p">,</span> <span class="nx">ipList</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">value</span><span class="p">)</span>
			<span class="p">}</span>
			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">()</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctrlC</span><span class="p">:</span>
			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;\nDetaching program and exit&#34;</span><span class="p">)</span>
			<span class="k">return</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">fatalError</span><span class="p">(</span><span class="nx">format</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">args</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintf</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span> <span class="nx">format</span><span class="o">+</span><span class="s">&#34;\n&#34;</span><span class="p">,</span> <span class="nx">args</span><span class="o">...</span><span class="p">)</span>
	<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">printBpfInfo</span><span class="p">(</span><span class="nx">bpf</span> <span class="nx">goebpf</span><span class="p">.</span><span class="nx">System</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Maps:&#34;</span><span class="p">)</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">item</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">bpf</span><span class="p">.</span><span class="nf">GetMaps</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;\t%s: %v, Fd %v\n&#34;</span><span class="p">,</span> <span class="nx">item</span><span class="p">.</span><span class="nf">GetName</span><span class="p">(),</span> <span class="nx">item</span><span class="p">.</span><span class="nf">GetType</span><span class="p">(),</span> <span class="nx">item</span><span class="p">.</span><span class="nf">GetFd</span><span class="p">())</span>
	<span class="p">}</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;\nPrograms:&#34;</span><span class="p">)</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">prog</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">bpf</span><span class="p">.</span><span class="nf">GetPrograms</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;\t%s: %v, size %d, license \&#34;%s\&#34;\n&#34;</span><span class="p">,</span>
			<span class="nx">prog</span><span class="p">.</span><span class="nf">GetName</span><span class="p">(),</span> <span class="nx">prog</span><span class="p">.</span><span class="nf">GetType</span><span class="p">(),</span> <span class="nx">prog</span><span class="p">.</span><span class="nf">GetSize</span><span class="p">(),</span> <span class="nx">prog</span><span class="p">.</span><span class="nf">GetLicense</span><span class="p">(),</span>
		<span class="p">)</span>

	<span class="p">}</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// Implements flag.Value
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">i</span> <span class="o">*</span><span class="nx">ipAddressList</span><span class="p">)</span> <span class="nf">String</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%+v&#34;</span><span class="p">,</span> <span class="o">*</span><span class="nx">i</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Implements flag.Value
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">i</span> <span class="o">*</span><span class="nx">ipAddressList</span><span class="p">)</span> <span class="nf">Set</span><span class="p">(</span><span class="nx">value</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="o">*</span><span class="nx">i</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;Up to 16 IPv4 addresses supported&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="c1">// Validate that value is correct IPv4 address
</span><span class="c1"></span>	<span class="k">if</span> <span class="p">!</span><span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="s">&#34;/&#34;</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">value</span> <span class="o">+=</span> <span class="s">&#34;/32&#34;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="s">&#34;:&#34;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;%s is not an IPv4 address&#34;</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">_</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">ParseCIDR</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="c1">// Valid, add to the list
</span><span class="c1"></span>	<span class="o">*</span><span class="nx">i</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="o">*</span><span class="nx">i</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></details>
<h2 id="03-fentry">03-fentry</h2>
<blockquote>
<p><a href="https://github.com/cilium/ebpf/tree/master/examples/fentry" target="_blank" rel="noopener noreffer">https://github.com/cilium/ebpf/tree/master/examples/fentry</a>
fentry 简单展示了使用 <a href="https://github.com/cilium/ebpf/" target="_blank" rel="noopener noreffer">cilium/ebpf</a> 来编写一个监控网络连接的 eBPF 应用：</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># go run -exec sudo ./fentry</span>
2021/11/06 17:51:15 Comm   Src addr      Port   -&gt; Dest addr        Port
2021/11/06 17:51:25 wget   10.0.2.15     <span class="m">49850</span>  -&gt; 142.250.72.228   <span class="m">443</span>
2021/11/06 17:51:46 ssh    10.0.2.15     <span class="m">58854</span>  -&gt; 10.0.2.1         <span class="m">22</span>
2021/11/06 18:13:15 curl   10.0.2.15     <span class="m">54268</span>  -&gt; 104.21.1.217     <span class="m">80</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="测试过程">测试过程</h3>
<p>我们还是有两个关键文件：</p>
<ul>
<li><code>fentry.c</code></li>
<li><code>main.go</code>
不过 <a href="https://github.com/cilium/ebpf/" target="_blank" rel="noopener noreffer">cilium/ebpf</a> 使用方法与 <code>02-basic-firewall</code> 中使用的 <a href="https://github.com/dropbox/goebpf" target="_blank" rel="noopener noreffer">dropbox/goebpf</a> 略有不同</li>
</ul>
<p>执行命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>ls 
<span class="go">fentry.c  go.mod  go.sum  main.go  Readme.md
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="gp">$ </span><span class="nb">export</span> <span class="nv">BPF_CLANG</span><span class="o">=</span>clang
<span class="gp">$ </span>go generate -x
<span class="go">go run github.com/cilium/ebpf/cmd/bpf2go -cc clang -cflags  -type event bpf fentry.c -- -I../headers
</span><span class="go">Compiled /home/one/projects/learn-xdp/code/03-fentry/bpf_bpfel.o
</span><span class="go">Stripped /home/one/projects/learn-xdp/code/03-fentry/bpf_bpfel.o
</span><span class="go">Wrote /home/one/projects/learn-xdp/code/03-fentry/bpf_bpfel.go
</span><span class="go">Compiled /home/one/projects/learn-xdp/code/03-fentry/bpf_bpfeb.o
</span><span class="go">Stripped /home/one/projects/learn-xdp/code/03-fentry/bpf_bpfeb.o
</span><span class="go">Wrote /home/one/projects/learn-xdp/code/03-fentry/bpf_bpfeb.go
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="gp">$ </span>ls
<span class="go">bpf_bpfeb.go  bpf_bpfeb.o  bpf_bpfel.go  bpf_bpfel.o  fentry.c  go.mod  go.sum  main.go  Readme.md
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="gp">$ </span>go build -x
<span class="go">WORK=/tmp/go-build2233003944
</span><span class="go">mkdir -p $WORK/b001/
</span><span class="go">cat &gt;$WORK/b001/importcfg.link &lt;&lt; &#39;EOF&#39; # internal
</span><span class="go">packagefile fentry=/home/one/.cache/go-build/05/05afeb631ffca9ae34ffe955c0420346a67dfdb58cf9c946b25ad609a8aa20cb-d
</span><span class="go">packagefile bytes=/usr/local/go/pkg/linux_amd64/bytes.a
</span><span class="go">packagefile embed=/usr/local/go/pkg/linux_amd64/embed.a
</span><span class="go">packagefile encoding/binary=/usr/local/go/pkg/linux_amd64/encoding/binary.a
</span><span class="go">packagefile errors=/usr/local/go/pkg/linux_amd64/errors.a
</span><span class="go">packagefile fmt=/usr/local/go/pkg/linux_amd64/fmt.a
</span><span class="go">packagefile github.com/cilium/ebpf=/home/one/.cache/go-build/bb/bb75ad96e6f3060bc53c9d6cd4e7a9f0632ac7507fcb98dd1c368013c8804779-d
</span><span class="go">packagefile github.com/cilium/ebpf/link=/home/one/.cache/go-build/57/574cc9adf9a576bec3e5d47107ef2eb25781ca95955f6f655e41b7f25f20bdf6-d
</span><span class="go">packagefile github.com/cilium/ebpf/ringbuf=/home/one/.cache/go-build/88/88af5c93c8bd50df50aa53ce777ecb40b3ae25f357e744bb79a23d43c164a696-d
</span><span class="go">packagefile github.com/cilium/ebpf/rlimit=/home/one/.cache/go-build/d5/d5d1f7fd55bd4197e4252f06520fca47e4036c5c90c372af3b83ee3a05819d7c-d
</span><span class="go">packagefile io=/usr/local/go/pkg/linux_amd64/io.a
</span><span class="go">packagefile log=/usr/local/go/pkg/linux_amd64/log.a
</span><span class="go">packagefile net=/usr/local/go/pkg/linux_amd64/net.a
</span><span class="go">packagefile os=/usr/local/go/pkg/linux_amd64/os.a
</span><span class="go">packagefile os/signal=/usr/local/go/pkg/linux_amd64/os/signal.a
</span><span class="go">packagefile syscall=/usr/local/go/pkg/linux_amd64/syscall.a
</span><span class="go">packagefile runtime=/usr/local/go/pkg/linux_amd64/runtime.a
</span><span class="go">packagefile internal/bytealg=/usr/local/go/pkg/linux_amd64/internal/bytealg.a
</span><span class="go">packagefile unicode=/usr/local/go/pkg/linux_amd64/unicode.a
</span><span class="go">packagefile unicode/utf8=/usr/local/go/pkg/linux_amd64/unicode/utf8.a
</span><span class="go">packagefile io/fs=/usr/local/go/pkg/linux_amd64/io/fs.a
</span><span class="go">packagefile time=/usr/local/go/pkg/linux_amd64/time.a
</span><span class="go">packagefile math=/usr/local/go/pkg/linux_amd64/math.a
</span><span class="go">packagefile reflect=/usr/local/go/pkg/linux_amd64/reflect.a
</span><span class="go">packagefile sync=/usr/local/go/pkg/linux_amd64/sync.a
</span><span class="go">packagefile internal/reflectlite=/usr/local/go/pkg/linux_amd64/internal/reflectlite.a
</span><span class="go">packagefile internal/fmtsort=/usr/local/go/pkg/linux_amd64/internal/fmtsort.a
</span><span class="go">packagefile strconv=/usr/local/go/pkg/linux_amd64/strconv.a
</span><span class="go">packagefile bufio=/usr/local/go/pkg/linux_amd64/bufio.a
</span><span class="go">packagefile debug/elf=/usr/local/go/pkg/linux_amd64/debug/elf.a
</span><span class="go">packagefile encoding=/usr/local/go/pkg/linux_amd64/encoding.a
</span><span class="go">packagefile encoding/hex=/usr/local/go/pkg/linux_amd64/encoding/hex.a
</span><span class="go">packagefile github.com/cilium/ebpf/asm=/home/one/.cache/go-build/61/6159d97cd31fcbc1a11f80851b62d261337159d03a8e767146a649a1c394fcf9-d
</span><span class="go">packagefile github.com/cilium/ebpf/internal=/home/one/.cache/go-build/38/38793cd7b9393ae4d3cd8520c231bec7da32fb8b1c189fe5fb055598aca2c80b-d
</span><span class="go">packagefile github.com/cilium/ebpf/internal/btf=/home/one/.cache/go-build/03/0373fd1a17f8b4faec77ce86925d8228310342c8c0a646c51dd1637a1affd437-d
</span><span class="go">packagefile github.com/cilium/ebpf/internal/sys=/home/one/.cache/go-build/3f/3fcbd9eb66b371c923a39d9ffc5755068b933f32a8e6e3f5450faa846d704fdd-d
</span><span class="go">packagefile github.com/cilium/ebpf/internal/unix=/home/one/.cache/go-build/4b/4bd01efed971b8a6f9f2f3c73b30517d6c14fab1692166b30add2413acca8019-d
</span><span class="go">packagefile math/rand=/usr/local/go/pkg/linux_amd64/math/rand.a
</span><span class="go">packagefile path/filepath=/usr/local/go/pkg/linux_amd64/path/filepath.a
</span><span class="go">packagefile strings=/usr/local/go/pkg/linux_amd64/strings.a
</span><span class="go">packagefile crypto/rand=/usr/local/go/pkg/linux_amd64/crypto/rand.a
</span><span class="go">packagefile regexp=/usr/local/go/pkg/linux_amd64/regexp.a
</span><span class="go">packagefile github.com/cilium/ebpf/internal/epoll=/home/one/.cache/go-build/63/63a04d9ca47394a87f84b91b444b3cc4e0ff897c4dc626fc2cbdc2f83ec02ab4-d
</span><span class="go">packagefile sync/atomic=/usr/local/go/pkg/linux_amd64/sync/atomic.a
</span><span class="go">packagefile context=/usr/local/go/pkg/linux_amd64/context.a
</span><span class="go">packagefile vendor/golang.org/x/net/dns/dnsmessage=/usr/local/go/pkg/linux_amd64/vendor/golang.org/x/net/dns/dnsmessage.a
</span><span class="go">packagefile internal/itoa=/usr/local/go/pkg/linux_amd64/internal/itoa.a
</span><span class="go">packagefile internal/nettrace=/usr/local/go/pkg/linux_amd64/internal/nettrace.a
</span><span class="go">packagefile internal/poll=/usr/local/go/pkg/linux_amd64/internal/poll.a
</span><span class="go">packagefile internal/singleflight=/usr/local/go/pkg/linux_amd64/internal/singleflight.a
</span><span class="go">packagefile sort=/usr/local/go/pkg/linux_amd64/sort.a
</span><span class="go">packagefile runtime/cgo=/usr/local/go/pkg/linux_amd64/runtime/cgo.a
</span><span class="go">packagefile internal/oserror=/usr/local/go/pkg/linux_amd64/internal/oserror.a
</span><span class="go">packagefile internal/syscall/execenv=/usr/local/go/pkg/linux_amd64/internal/syscall/execenv.a
</span><span class="go">packagefile internal/syscall/unix=/usr/local/go/pkg/linux_amd64/internal/syscall/unix.a
</span><span class="go">packagefile internal/testlog=/usr/local/go/pkg/linux_amd64/internal/testlog.a
</span><span class="go">packagefile internal/unsafeheader=/usr/local/go/pkg/linux_amd64/internal/unsafeheader.a
</span><span class="go">packagefile internal/race=/usr/local/go/pkg/linux_amd64/internal/race.a
</span><span class="go">packagefile internal/abi=/usr/local/go/pkg/linux_amd64/internal/abi.a
</span><span class="go">packagefile internal/cpu=/usr/local/go/pkg/linux_amd64/internal/cpu.a
</span><span class="go">packagefile internal/goexperiment=/usr/local/go/pkg/linux_amd64/internal/goexperiment.a
</span><span class="go">packagefile runtime/internal/atomic=/usr/local/go/pkg/linux_amd64/runtime/internal/atomic.a
</span><span class="go">packagefile runtime/internal/math=/usr/local/go/pkg/linux_amd64/runtime/internal/math.a
</span><span class="go">packagefile runtime/internal/sys=/usr/local/go/pkg/linux_amd64/runtime/internal/sys.a
</span><span class="go">packagefile path=/usr/local/go/pkg/linux_amd64/path.a
</span><span class="go">packagefile math/bits=/usr/local/go/pkg/linux_amd64/math/bits.a
</span><span class="go">packagefile compress/zlib=/usr/local/go/pkg/linux_amd64/compress/zlib.a
</span><span class="go">packagefile debug/dwarf=/usr/local/go/pkg/linux_amd64/debug/dwarf.a
</span><span class="go">packagefile crypto/sha1=/usr/local/go/pkg/linux_amd64/crypto/sha1.a
</span><span class="go">packagefile compress/gzip=/usr/local/go/pkg/linux_amd64/compress/gzip.a
</span><span class="go">packagefile go/format=/usr/local/go/pkg/linux_amd64/go/format.a
</span><span class="go">packagefile go/scanner=/usr/local/go/pkg/linux_amd64/go/scanner.a
</span><span class="go">packagefile golang.org/x/sys/unix=/home/one/.cache/go-build/e3/e350d35a006096f93720de170f222188938324e6fb801c743e5f8c4aa58778a8-d
</span><span class="go">packagefile crypto/aes=/usr/local/go/pkg/linux_amd64/crypto/aes.a
</span><span class="go">packagefile crypto/cipher=/usr/local/go/pkg/linux_amd64/crypto/cipher.a
</span><span class="go">packagefile math/big=/usr/local/go/pkg/linux_amd64/math/big.a
</span><span class="go">packagefile regexp/syntax=/usr/local/go/pkg/linux_amd64/regexp/syntax.a
</span><span class="go">packagefile compress/flate=/usr/local/go/pkg/linux_amd64/compress/flate.a
</span><span class="go">packagefile hash=/usr/local/go/pkg/linux_amd64/hash.a
</span><span class="go">packagefile hash/adler32=/usr/local/go/pkg/linux_amd64/hash/adler32.a
</span><span class="go">packagefile crypto=/usr/local/go/pkg/linux_amd64/crypto.a
</span><span class="go">packagefile hash/crc32=/usr/local/go/pkg/linux_amd64/hash/crc32.a
</span><span class="go">packagefile go/ast=/usr/local/go/pkg/linux_amd64/go/ast.a
</span><span class="go">packagefile go/parser=/usr/local/go/pkg/linux_amd64/go/parser.a
</span><span class="go">packagefile go/printer=/usr/local/go/pkg/linux_amd64/go/printer.a
</span><span class="go">packagefile go/token=/usr/local/go/pkg/linux_amd64/go/token.a
</span><span class="go">packagefile golang.org/x/sys/internal/unsafeheader=/home/one/.cache/go-build/6a/6a7e989ebbfedf98565db211897ba56b81b3aedac17163de313c0c607ec965e0-d
</span><span class="go">packagefile crypto/internal/subtle=/usr/local/go/pkg/linux_amd64/crypto/internal/subtle.a
</span><span class="go">packagefile crypto/subtle=/usr/local/go/pkg/linux_amd64/crypto/subtle.a
</span><span class="go">packagefile go/internal/typeparams=/usr/local/go/pkg/linux_amd64/go/internal/typeparams.a
</span><span class="go">packagefile go/build/constraint=/usr/local/go/pkg/linux_amd64/go/build/constraint.a
</span><span class="go">packagefile text/tabwriter=/usr/local/go/pkg/linux_amd64/text/tabwriter.a
</span><span class="go">EOF
</span><span class="go">mkdir -p $WORK/b001/exe/
</span><span class="go">cd .
</span><span class="go">/usr/local/go/pkg/tool/linux_amd64/link -o $WORK/b001/exe/a.out -importcfg $WORK/b001/importcfg.link -buildmode=exe -buildid=MnkrPODJV6gUe4dJ3oiz/N3b6ktoNojfUQaAJhOC1/SbK_zV15o20Ks7PcLnsi/MnkrPODJV6gUe4dJ3oiz -extld=gcc /home/one/.cache/go-build/05/05afeb631ffca9ae34ffe955c0420346a67dfdb58cf9c946b25ad609a8aa20cb-d
</span><span class="go">/usr/local/go/pkg/tool/linux_amd64/buildid -w $WORK/b001/exe/a.out # internal
</span><span class="go">cp $WORK/b001/exe/a.out fentry
</span><span class="go">rm -r $WORK/b001/
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="gp">$ </span>ls
<span class="go">bpf_bpfeb.go  bpf_bpfeb.o  bpf_bpfel.go  bpf_bpfel.o  fentry*  fentry.c  go.mod  go.sum  main.go  Readme.md
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="gp">$ </span>sudo ./fentry 
<span class="go">2022/03/02 18:51:55 Comm             Src addr        Port   -&gt; Dest addr       Port  
</span><span class="go">2022/03/02 18:51:58 code 10.78.12.138    40946  -&gt; 13.69.239.74    443   
</span><span class="go">2022/03/02 18:51:58 code 10.78.12.138    40948  -&gt; 13.69.239.74    443   
</span><span class="go">2022/03/02 18:51:58 code 10.78.12.138    56972  -&gt; 20.50.73.10     443   
</span><span class="go">2022/03/02 18:51:58 code 10.78.12.138    56974  -&gt; 20.50.73.10     443   
</span><span class="go">2022/03/02 18:52:00 code 10.78.12.138    56976  -&gt; 20.50.73.10     443   
</span><span class="go">2022/03/02 18:52:01 code 127.0.0.1       33744  -&gt; 127.0.0.1       8889  
</span><span class="go">2022/03/02 18:52:01 v2ray 127.0.0.1       42560  -&gt; 127.0.0.1       15000 
</span><span class="go">2022/03/02 18:52:01 SSRThread 10.78.12.138    34834  -&gt; 183.240.60.84   30114 
</span><span class="go">2022/03/02 18:52:01 code 127.0.0.1       33746  -&gt; 127.0.0.1       8889  
</span><span class="go">2022/03/02 18:52:01 v2ray 127.0.0.1       42562  -&gt; 127.0.0.1       15000 
</span><span class="go">2022/03/02 18:52:01 SSRThread 10.78.12.138    34836  -&gt; 183.240.60.84   30114 
</span><span class="go">^C2022/03/02 18:52:03 received signal, exiting..
</span></code></pre></td></tr></table>
</div>
</div><h3 id="go-generate">go generate</h3>
<p>和 <a href="https://github.com/dropbox/goebpf" target="_blank" rel="noopener noreffer">dropbox/goebpf</a> 不同，<a href="https://github.com/cilium/ebpf/" target="_blank" rel="noopener noreffer">cilium/ebpf</a> 充分利用了 Go 的特性，<code>go generate</code> 就是其一。<code>go generate</code> 可以把编译命令写在代码注释中，在编译前自动化生成某类代码。本例中的 <code>go generate</code> 部分在 <code>mian.go</code> 中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// $BPF_CLANG and $BPF_CFLAGS are set by the Makefile.
</span><span class="c1">//go:generate go run github.com/cilium/ebpf/cmd/bpf2go -cc $BPF_CLANG -cflags $BPF_CFLAGS -type event bpf fentry.c -- -I../headers
</span></code></pre></td></tr></table>
</div>
</div><p>和之前直接编译 eBPF 的命令比较一下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>clang -O2 -Wall -target bpf -c xdp-example.c -o xdp-example.o
</code></pre></td></tr></table>
</div>
</div><p>会发现有点相似，区别是 <code>go generate</code> 还用到了 <a href="https://github.com/cilium/ebpf/cmd/bpf2go" target="_blank" rel="noopener noreffer">bpf2go</a>。<code>bpf2go</code>允许在 Go 代码中编译和嵌入用 C 编写的 eBPF 程序。除了编译 C 代码之外，它还自动生成 Go 代码以加载和操作 eBPF 程序和映射对象。<br>
再来看之前执行的命令，<code>go generate</code> 加了 <code>-x</code> 可以看到更多的输出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span><span class="nb">export</span> <span class="nv">BPF_CLANG</span><span class="o">=</span>clang
<span class="gp">$ </span>go generate -x
<span class="go">go run github.com/cilium/ebpf/cmd/bpf2go -cc clang -cflags  -type event bpf fentry.c -- -I../headers
</span><span class="go">Compiled /home/one/projects/learn-xdp/code/03-fentry/bpf_bpfel.o
</span><span class="go">Stripped /home/one/projects/learn-xdp/code/03-fentry/bpf_bpfel.o
</span><span class="go">Wrote /home/one/projects/learn-xdp/code/03-fentry/bpf_bpfel.go
</span><span class="go">Compiled /home/one/projects/learn-xdp/code/03-fentry/bpf_bpfeb.o
</span><span class="go">Stripped /home/one/projects/learn-xdp/code/03-fentry/bpf_bpfeb.o
</span><span class="go">Wrote /home/one/projects/learn-xdp/code/03-fentry/bpf_bpfeb.go
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="gp">$ </span>ls
<span class="go">bpf_bpfeb.go  bpf_bpfeb.o  bpf_bpfel.go  bpf_bpfel.o  fentry.c  go.mod  go.sum  main.go  Readme.md
</span></code></pre></td></tr></table>
</div>
</div><p>发现多了四个文件：<code>bpf_bpfeb.go  bpf_bpfeb.o  bpf_bpfel.go  bpf_bpfel.o</code>，<code>.o</code>文件是编译好的 eBPF 字节码，<code>.go</code>文件是负责把字节码加载到go程序中，这使用到了go1.16新增的<code>go:embed</code>特性。另外文件名中的<code>b</code>和<code>l</code>分别代表大端字节序（big endian）和小端字节序（little endian）。
使用<code>llvm-objdump</code>进行反汇编：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>llvm-objdump -S bpf_bpfeb.o
<span class="err">
</span><span class="err"></span><span class="go">bpf_bpfeb.o:    file format ELF64-BPF
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">Disassembly of section fentry/tcp_connect:
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">0000000000000000 tcp_connect:
</span><span class="go">llvm-objdump: warning: &#39;bpf_bpfeb.o&#39;: failed to parse debug information for bpf_bpfeb.o
</span><span class="go">       0:       79 71 00 00 00 00 00 00 r7 = *(u64 *)(r1 + 0)
</span><span class="go">       1:       69 17 00 10 00 00 00 00 r1 = *(u16 *)(r7 + 16)
</span><span class="go">       2:       55 10 00 15 00 00 00 02 if r1 != 2 goto +21 &lt;LBB0_3&gt;
</span><span class="go">       3:       18 10 00 00 00 00 00 00 00 00 00 00 00 00 00 00 r1 = 0 ll
</span><span class="go">       5:       b7 20 00 00 00 00 00 1c r2 = 28
</span><span class="go">       6:       b7 30 00 00 00 00 00 00 r3 = 0
</span><span class="go">       7:       85 00 00 00 00 00 00 83 call 131
</span><span class="go">       8:       bf 60 00 00 00 00 00 00 r6 = r0
</span><span class="go">       9:       15 60 00 0e 00 00 00 00 if r6 == 0 goto +14 &lt;LBB0_3&gt;
</span><span class="go">      10:       61 17 00 04 00 00 00 00 r1 = *(u32 *)(r7 + 4)
</span><span class="go">      11:       63 61 00 14 00 00 00 00 *(u32 *)(r6 + 20) = r1
</span><span class="go">      12:       61 17 00 00 00 00 00 00 r1 = *(u32 *)(r7 + 0)
</span><span class="go">      13:       63 61 00 18 00 00 00 00 *(u32 *)(r6 + 24) = r1
</span><span class="go">      14:       69 17 00 0c 00 00 00 00 r1 = *(u16 *)(r7 + 12)
</span><span class="go">      15:       6b 61 00 12 00 00 00 00 *(u16 *)(r6 + 18) = r1
</span><span class="go">      16:       69 17 00 0e 00 00 00 00 r1 = *(u16 *)(r7 + 14)
</span><span class="go">      17:       6b 61 00 10 00 00 00 00 *(u16 *)(r6 + 16) = r1
</span><span class="go">      18:       bf 16 00 00 00 00 00 00 r1 = r6
</span><span class="go">      19:       b7 20 00 00 00 00 00 10 r2 = 16
</span><span class="go">      20:       85 00 00 00 00 00 00 10 call 16
</span><span class="go">      21:       bf 16 00 00 00 00 00 00 r1 = r6
</span><span class="go">      22:       b7 20 00 00 00 00 00 00 r2 = 0
</span><span class="go">      23:       85 00 00 00 00 00 00 84 call 132
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">00000000000000c0 LBB0_3:
</span><span class="go">      24:       b7 00 00 00 00 00 00 00 r0 = 0
</span><span class="go">      25:       95 00 00 00 00 00 00 00 exit
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="gp">$ </span>llvm-objdump -S bpf_bpfel.o
<span class="err">
</span><span class="err"></span><span class="go">bpf_bpfel.o:    file format ELF64-BPF
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">Disassembly of section fentry/tcp_connect:
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">0000000000000000 tcp_connect:
</span><span class="go">llvm-objdump: warning: &#39;bpf_bpfel.o&#39;: failed to parse debug information for bpf_bpfel.o
</span><span class="go">       0:       79 17 00 00 00 00 00 00 r7 = *(u64 *)(r1 + 0)
</span><span class="go">       1:       69 71 10 00 00 00 00 00 r1 = *(u16 *)(r7 + 16)
</span><span class="go">       2:       55 01 16 00 02 00 00 00 if r1 != 2 goto +22 &lt;LBB0_3&gt;
</span><span class="go">       3:       18 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 r1 = 0 ll
</span><span class="go">       5:       b7 02 00 00 1c 00 00 00 r2 = 28
</span><span class="go">       6:       b7 03 00 00 00 00 00 00 r3 = 0
</span><span class="go">       7:       85 00 00 00 83 00 00 00 call 131
</span><span class="go">       8:       bf 06 00 00 00 00 00 00 r6 = r0
</span><span class="go">       9:       15 06 0f 00 00 00 00 00 if r6 == 0 goto +15 &lt;LBB0_3&gt;
</span><span class="go">      10:       61 71 04 00 00 00 00 00 r1 = *(u32 *)(r7 + 4)
</span><span class="go">      11:       63 16 14 00 00 00 00 00 *(u32 *)(r6 + 20) = r1
</span><span class="go">      12:       61 71 00 00 00 00 00 00 r1 = *(u32 *)(r7 + 0)
</span><span class="go">      13:       63 16 18 00 00 00 00 00 *(u32 *)(r6 + 24) = r1
</span><span class="go">      14:       69 71 0c 00 00 00 00 00 r1 = *(u16 *)(r7 + 12)
</span><span class="go">      15:       6b 16 12 00 00 00 00 00 *(u16 *)(r6 + 18) = r1
</span><span class="go">      16:       69 71 0e 00 00 00 00 00 r1 = *(u16 *)(r7 + 14)
</span><span class="go">      17:       dc 01 00 00 10 00 00 00 r1 = be16 r1
</span><span class="go">      18:       6b 16 10 00 00 00 00 00 *(u16 *)(r6 + 16) = r1
</span><span class="go">      19:       bf 61 00 00 00 00 00 00 r1 = r6
</span><span class="go">      20:       b7 02 00 00 10 00 00 00 r2 = 16
</span><span class="go">      21:       85 00 00 00 10 00 00 00 call 16
</span><span class="go">      22:       bf 61 00 00 00 00 00 00 r1 = r6
</span><span class="go">      23:       b7 02 00 00 00 00 00 00 r2 = 0
</span><span class="go">      24:       85 00 00 00 84 00 00 00 call 132
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">00000000000000c8 LBB0_3:
</span><span class="go">      25:       b7 00 00 00 00 00 00 00 r0 = 0
</span><span class="go">      26:       95 00 00 00 00 00 00 00 exit
</span></code></pre></td></tr></table>
</div>
</div><p><code>bpf_bpfeb.go</code>开头的注释，指明架构：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Code generated by bpf2go; DO NOT EDIT.
</span><span class="c1">//go:build arm64be || armbe || mips || mips64 || mips64p32 || ppc64 || s390 || s390x || sparc || sparc64
</span><span class="c1">// +build arm64be armbe mips mips64 mips64p32 ppc64 s390 s390x sparc sparc64
</span></code></pre></td></tr></table>
</div>
</div><p><code>bpf_bpfel.go</code>中的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Code generated by bpf2go; DO NOT EDIT.
</span><span class="c1">//go:build 386 || amd64 || amd64p32 || arm || arm64 || mips64le || mips64p32le || mipsle || ppc64le || riscv64
</span><span class="c1">// +build 386 amd64 amd64p32 arm arm64 mips64le mips64p32le mipsle ppc64le riscv64
</span></code></pre></td></tr></table>
</div>
</div><h3 id="go-build">go build</h3>
<p>接下来执行了<code>go build -x</code>，<code>-x</code>参数也是为了输出更多信息。<code>go build</code>是go程序的构建命令，整个过程是找出所有引用的文件，静态编译为一个单独的文件。</p>
<h3 id="代码-1">代码</h3>
<details>
<summary>fentry.c</summary>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="c1">// +build ignore
</span><span class="c1"></span>
<span class="cp">#include</span> <span class="cpf">&#34;common.h&#34;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&#34;bpf_endian.h&#34;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&#34;bpf_helpers.h&#34;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&#34;bpf_tracing.h&#34;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#define AF_INET 2
</span><span class="cp">#define TASK_COMM_LEN 16
</span><span class="cp"></span>
<span class="kt">char</span> <span class="n">LICENSE</span><span class="p">[]</span> <span class="n">SEC</span><span class="p">(</span><span class="s">&#34;license&#34;</span><span class="p">)</span> <span class="o">=</span> <span class="s">&#34;Dual MIT/GPL&#34;</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">sock_common</span> <span class="p">{</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">__be32</span> <span class="n">skc_daddr</span><span class="p">;</span>
			<span class="n">__be32</span> <span class="n">skc_rcv_saddr</span><span class="p">;</span>
		<span class="p">};</span>
	<span class="p">};</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">skc_hash</span><span class="p">;</span>
		<span class="n">__u16</span> <span class="n">skc_u16hashes</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="p">};</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">__be16</span> <span class="n">skc_dport</span><span class="p">;</span>
			<span class="n">__u16</span> <span class="n">skc_num</span><span class="p">;</span>
		<span class="p">};</span>
	<span class="p">};</span>
	<span class="kt">short</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">skc_family</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sock</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock_common</span> <span class="n">__sk_common</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="p">{</span>
	<span class="n">__uint</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">BPF_MAP_TYPE_RINGBUF</span><span class="p">);</span>
	<span class="n">__uint</span><span class="p">(</span><span class="n">max_entries</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
<span class="p">}</span> <span class="n">events</span> <span class="n">SEC</span><span class="p">(</span><span class="s">&#34;.maps&#34;</span><span class="p">);</span>

<span class="c1">// Force emitting struct event into the ELF.
</span><span class="c1"></span><span class="k">const</span> <span class="k">struct</span> <span class="n">event</span> <span class="o">*</span><span class="n">unused</span> <span class="nf">__attribute__</span><span class="p">((</span><span class="n">unused</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">event</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">comm</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">__u16</span> <span class="n">sport</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">dport</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">saddr</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">daddr</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">SEC</span><span class="p">(</span><span class="s">&#34;fentry/tcp_connect&#34;</span><span class="p">)</span>
<span class="kt">int</span> <span class="n">BPF_PROG</span><span class="p">(</span><span class="n">tcp_connect</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">__sk_common</span><span class="p">.</span><span class="n">skc_family</span> <span class="o">!=</span> <span class="n">AF_INET</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">struct</span> <span class="n">event</span> <span class="o">*</span><span class="n">tcp_info</span><span class="p">;</span>
	<span class="n">tcp_info</span> <span class="o">=</span> <span class="n">bpf_ringbuf_reserve</span><span class="p">(</span><span class="o">&amp;</span><span class="n">events</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">event</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tcp_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tcp_info</span><span class="o">-&gt;</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">__sk_common</span><span class="p">.</span><span class="n">skc_rcv_saddr</span><span class="p">;</span>
	<span class="n">tcp_info</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">__sk_common</span><span class="p">.</span><span class="n">skc_daddr</span><span class="p">;</span>
	<span class="n">tcp_info</span><span class="o">-&gt;</span><span class="n">dport</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">__sk_common</span><span class="p">.</span><span class="n">skc_dport</span><span class="p">;</span>
	<span class="n">tcp_info</span><span class="o">-&gt;</span><span class="n">sport</span> <span class="o">=</span> <span class="n">bpf_htons</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">__sk_common</span><span class="p">.</span><span class="n">skc_num</span><span class="p">);</span>

	<span class="n">bpf_get_current_comm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_info</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">TASK_COMM_LEN</span><span class="p">);</span>

	<span class="n">bpf_ringbuf_submit</span><span class="p">(</span><span class="n">tcp_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></details> 
<details>
<summary>main.go</summary>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">//go:build linux
</span><span class="c1">// +build linux
</span><span class="c1"></span>
<span class="c1">// This program demonstrates attaching a fentry eBPF program to
</span><span class="c1">// tcp_connect. It prints the command/IPs/ports information
</span><span class="c1">// once the host sent a TCP SYN packet to a destination.
</span><span class="c1">// It supports IPv4 at this example.
</span><span class="c1">//
</span><span class="c1">// Sample output:
</span><span class="c1">//
</span><span class="c1">// examples# go run -exec sudo ./fentry
</span><span class="c1">// 2021/11/06 17:51:15 Comm   Src addr      Port   -&gt; Dest addr        Port
</span><span class="c1">// 2021/11/06 17:51:25 wget   10.0.2.15     49850  -&gt; 142.250.72.228   443
</span><span class="c1">// 2021/11/06 17:51:46 ssh    10.0.2.15     58854  -&gt; 10.0.2.1         22
</span><span class="c1">// 2021/11/06 18:13:15 curl   10.0.2.15     54268  -&gt; 104.21.1.217     80
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;bytes&#34;</span>
	<span class="s">&#34;encoding/binary&#34;</span>
	<span class="s">&#34;errors&#34;</span>
	<span class="s">&#34;log&#34;</span>
	<span class="s">&#34;net&#34;</span>
	<span class="s">&#34;os&#34;</span>
	<span class="s">&#34;os/signal&#34;</span>
	<span class="s">&#34;syscall&#34;</span>

	<span class="s">&#34;github.com/cilium/ebpf/link&#34;</span>
	<span class="s">&#34;github.com/cilium/ebpf/ringbuf&#34;</span>
	<span class="s">&#34;github.com/cilium/ebpf/rlimit&#34;</span>
<span class="p">)</span>

<span class="c1">// $BPF_CLANG and $BPF_CFLAGS are set by the Makefile.
</span><span class="c1">//go:generate go run github.com/cilium/ebpf/cmd/bpf2go -cc $BPF_CLANG -cflags $BPF_CFLAGS -type event bpf fentry.c -- -I../headers
</span><span class="c1"></span>
<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">stopper</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Signal</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
	<span class="nx">signal</span><span class="p">.</span><span class="nf">Notify</span><span class="p">(</span><span class="nx">stopper</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Interrupt</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGTERM</span><span class="p">)</span>

	<span class="c1">// Allow the current process to lock memory for eBPF resources.
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rlimit</span><span class="p">.</span><span class="nf">RemoveMemlock</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// Load pre-compiled programs and maps into the kernel.
</span><span class="c1"></span>	<span class="nx">objs</span> <span class="o">:=</span> <span class="nx">bpfObjects</span><span class="p">{}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">loadBpfObjects</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">objs</span><span class="p">,</span> <span class="kc">nil</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;loading objects: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="nx">objs</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

	<span class="nx">link</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">link</span><span class="p">.</span><span class="nf">AttachTracing</span><span class="p">(</span><span class="nx">link</span><span class="p">.</span><span class="nx">TracingOptions</span><span class="p">{</span>
		<span class="nx">Program</span><span class="p">:</span> <span class="nx">objs</span><span class="p">.</span><span class="nx">bpfPrograms</span><span class="p">.</span><span class="nx">TcpConnect</span><span class="p">,</span>
	<span class="p">})</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="nx">link</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

	<span class="nx">rd</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ringbuf</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">objs</span><span class="p">.</span><span class="nx">bpfMaps</span><span class="p">.</span><span class="nx">Events</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;opening ringbuf reader: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="nx">rd</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="o">&lt;-</span><span class="nx">stopper</span>

		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rd</span><span class="p">.</span><span class="nf">Close</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;closing ringbuf reader: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}()</span>

	<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%-16s %-15s %-6s -&gt; %-15s %-6s&#34;</span><span class="p">,</span>
		<span class="s">&#34;Comm&#34;</span><span class="p">,</span>
		<span class="s">&#34;Src addr&#34;</span><span class="p">,</span>
		<span class="s">&#34;Port&#34;</span><span class="p">,</span>
		<span class="s">&#34;Dest addr&#34;</span><span class="p">,</span>
		<span class="s">&#34;Port&#34;</span><span class="p">,</span>
	<span class="p">)</span>

	<span class="c1">// bpfEvent is generated by bpf2go.
</span><span class="c1"></span>	<span class="kd">var</span> <span class="nx">event</span> <span class="nx">bpfEvent</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="nx">record</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rd</span><span class="p">.</span><span class="nf">Read</span><span class="p">()</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">ringbuf</span><span class="p">.</span><span class="nx">ErrClosed</span><span class="p">)</span> <span class="p">{</span>
				<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;received signal, exiting..&#34;</span><span class="p">)</span>
				<span class="k">return</span>
			<span class="p">}</span>
			<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;reading from reader: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
			<span class="k">continue</span>
		<span class="p">}</span>

		<span class="c1">// Parse the ringbuf event entry into a bpfEvent structure.
</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">binary</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nf">NewBuffer</span><span class="p">(</span><span class="nx">record</span><span class="p">.</span><span class="nx">RawSample</span><span class="p">),</span> <span class="nx">binary</span><span class="p">.</span><span class="nx">BigEndian</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">event</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;parsing ringbuf event: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
			<span class="k">continue</span>
		<span class="p">}</span>

		<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%-16s %-15s %-6d -&gt; %-15s %-6d&#34;</span><span class="p">,</span>
			<span class="nx">event</span><span class="p">.</span><span class="nx">Comm</span><span class="p">,</span>
			<span class="nf">intToIP</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">Saddr</span><span class="p">),</span>
			<span class="nx">event</span><span class="p">.</span><span class="nx">Sport</span><span class="p">,</span>
			<span class="nf">intToIP</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">Daddr</span><span class="p">),</span>
			<span class="nx">event</span><span class="p">.</span><span class="nx">Dport</span><span class="p">,</span>
		<span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// intToIP converts IPv4 number to net.IP
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">intToIP</span><span class="p">(</span><span class="nx">ipNum</span> <span class="kt">uint32</span><span class="p">)</span> <span class="nx">net</span><span class="p">.</span><span class="nx">IP</span> <span class="p">{</span>
	<span class="nx">ip</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="nx">net</span><span class="p">.</span><span class="nx">IP</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
	<span class="nx">binary</span><span class="p">.</span><span class="nx">BigEndian</span><span class="p">.</span><span class="nf">PutUint32</span><span class="p">(</span><span class="nx">ip</span><span class="p">,</span> <span class="nx">ipNum</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">ip</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></details>
<h2 id="04-xdp1-c">04-xdp1-c</h2>
<p>原始代码来自 <a href="https://elixir.bootlin.com/linux/latest/source/samples/bpf" target="_blank" rel="noopener noreffer">samples/bpf</a> 中的 <code>xdp1_kern.c  xdp1_user.c</code>。</p>
<p>任务：</p>
<ol>
<li>首先解决原始代码里混乱的头文件依赖，让代码可以单独编译。</li>
<li>看懂代码实现，包括细节。</li>
<li>使用 <a href="https://github.com/cilium/ebpf/" target="_blank" rel="noopener noreffer">cilium/ebpf</a> 重新实现整个程序。</li>
</ol>
<h3 id="混乱的头文件">混乱的头文件</h3>
<p><code>xdp1_kern.c</code>中引入的头文件如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;uapi/linux/bpf.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/in.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/if_ether.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/if_packet.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/if_vlan.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/ip.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/ipv6.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&#34;bpf_helpers.h&#34;</span><span class="cp">
</span></code></pre></td></tr></table>
</div>
</div><p><code>&lt;uapi/linux/bpf.h&gt;</code>  和  <code>&quot;bpf_helpers.h&quot;</code>  与 eBPF 相关，但前者是从系统路径引入，后者从当前路径引入，不够统一，另外  <code>&lt;uapi/linux/bpf.h&gt;</code>  系统里默认是没有的。
<code>xdp1_user.c</code>中引入的头文件如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;linux/bpf.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/if_link.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;signal.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;libgen.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/resource.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;net/if.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&#34;bpf_util.h&#34;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&#34;bpf.h&#34;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&#34;libbpf.h&#34;</span><span class="cp">
</span></code></pre></td></tr></table>
</div>
</div><p><code>&lt;linux/bpf.h&gt;</code>，<code>&quot;bpf_util.h&quot;</code>，<code>&quot;bpf.h&quot;</code>，<code>&quot;libbpf.h&quot;</code>与 eBPF 相关，但又有引入路径不统一的问题，另外还有两个 <code>bpf.h</code> 文件，同样造成困扰。
首先就需要解决这样混乱的头文件引用。</p>
<p>考虑使用 <a href="https://github.com/libbpf/libbpf" target="_blank" rel="noopener noreffer">libbpf</a> 来解决。</p>
<p>使用 <code>git submodule</code> 添加 <a href="https://github.com/libbpf/libbpf" target="_blank" rel="noopener noreffer">libbpf</a> 到代码库：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">git submodule add https://github.com/libbpf/libbpf/ code/libbpf
</code></pre></td></tr></table>
</div>
</div><p>libbpf 依赖 libelf，检查是否安装：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>apt search libelf
<span class="go">正在排序... 完成
</span><span class="go">全文搜索... 完成
</span><span class="go">libdwarf++0/focal 0.3-1ubuntu2 amd64
</span><span class="go">  C++11 DWARF parser
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">libelf++0/focal 0.3-1ubuntu2 amd64
</span><span class="go">  C++11 ELF parser
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">libelf-dev/focal,now 0.176-1.1build1 amd64 [已安装]
</span><span class="go">  libelf1 development libraries and header files
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">libelf-freebsd-1/focal 10.3~svn296373-10 amd64
</span><span class="go">  library to read and write ELF files
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">libelf-freebsd-dev/focal 10.3~svn296373-10 amd64
</span><span class="go">  Development files for libelf (FreeBSD version)
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">libelf1/focal,now 0.176-1.1build1 amd64 [已安装，自动]
</span><span class="go">  library to read and write ELF files
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">libelfin-dev/focal 0.3-1ubuntu2 amd64
</span><span class="go">  C++11 ELF/DWARF parser (development files)
</span></code></pre></td></tr></table>
</div>
</div><p>构建静态 <code>libbpf.a</code> 和共享 <code>libbpf.so</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span><span class="nb">cd</span> libbpf/src/
<span class="gp">$ </span>make
<span class="go">  MKDIR    staticobjs
</span><span class="go">  CC       staticobjs/bpf.o
</span><span class="go">  CC       staticobjs/btf.o
</span><span class="go">  CC       staticobjs/libbpf.o
</span><span class="go">  CC       staticobjs/libbpf_errno.o
</span><span class="go">  CC       staticobjs/netlink.o
</span><span class="go">  CC       staticobjs/nlattr.o
</span><span class="go">  CC       staticobjs/str_error.o
</span><span class="go">  CC       staticobjs/libbpf_probes.o
</span><span class="go">  CC       staticobjs/bpf_prog_linfo.o
</span><span class="go">  CC       staticobjs/xsk.o
</span><span class="go">  CC       staticobjs/btf_dump.o
</span><span class="go">  CC       staticobjs/hashmap.o
</span><span class="go">  CC       staticobjs/ringbuf.o
</span><span class="go">  CC       staticobjs/strset.o
</span><span class="go">  CC       staticobjs/linker.o
</span><span class="go">  CC       staticobjs/gen_loader.o
</span><span class="go">  CC       staticobjs/relo_core.o
</span><span class="go">  AR       libbpf.a
</span><span class="go">  MKDIR    sharedobjs
</span><span class="go">  CC       sharedobjs/bpf.o
</span><span class="go">  CC       sharedobjs/btf.o
</span><span class="go">  CC       sharedobjs/libbpf.o
</span><span class="go">  CC       sharedobjs/libbpf_errno.o
</span><span class="go">  CC       sharedobjs/netlink.o
</span><span class="go">  CC       sharedobjs/nlattr.o
</span><span class="go">  CC       sharedobjs/str_error.o
</span><span class="go">  CC       sharedobjs/libbpf_probes.o
</span><span class="go">  CC       sharedobjs/bpf_prog_linfo.o
</span><span class="go">  CC       sharedobjs/xsk.o
</span><span class="go">  CC       sharedobjs/btf_dump.o
</span><span class="go">  CC       sharedobjs/hashmap.o
</span><span class="go">  CC       sharedobjs/ringbuf.o
</span><span class="go">  CC       sharedobjs/strset.o
</span><span class="go">  CC       sharedobjs/linker.o
</span><span class="go">  CC       sharedobjs/gen_loader.o
</span><span class="go">  CC       sharedobjs/relo_core.o
</span><span class="go">  CC       libbpf.so.0.7.0
</span></code></pre></td></tr></table>
</div>
</div><h2 id="05-xdp1-go">05-xdp1-go</h2>
<p><code>04-xdp1-c</code> 的go版本 </p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2022-03-08</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/secure/about-xdp/" class="prev" rel="prev" title="XDP 技术手册"><i class="fas fa-angle-left fa-fw"></i>XDP 技术手册</a>
            <a href="/posts/secure/dev-ebpf-with-go/" class="next" rel="next" title="使用 Go 来开发 eBPF">使用 Go 来开发 eBPF<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.91.2">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
